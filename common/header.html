<script src="https://unpkg.com/markerjs"></script>


<script>

//Save unsaved marker state before reopening when resizing reply-control
       function saveState(newObj, image, mark){
                   newObj.img = image
                   newObj.previousState = mark.getState();
                   return newObj
   }

   function findAllIndexes(string,word){
    let result = [];
    let dif = 0;
    while(true){
      let index = string.indexOf(word);
      if(index === -1) break;
      else{
        result.push(index + dif);
        let cur = string.length;
        string = string.substring(index + word.length);
        dif += cur - string.length;
      }
    }
    return result;
  }
  
// Display Markerjs
       let previousState
       function showMarkerJs(img, config) {
            let mark = new markerjs.MarkerArea(img, {previousState: config});
            let $editor = $('#reply-control textarea.d-editor-input').first()[0].value;
            let $editorVal = $('#reply-control textarea.d-editor-input');
            let result = findAllIndexes($editor,"upload://");
            let images = $('.d-editor-preview img');

            // console.log('result[0 ',result[0])
            // let substr = $editor.substring(result[0]+9,result[0]+36)
            // console.log('str  ', substr)

            //Exec after marker's toolbar checkmark is clicked
            mark.show((dataUrl) => {
              // generating image src into blob url
              let x = dataUrl;
              x = x.split(',').pop();

              const src = x;
              const byteChar = atob(src)
              const byteNum = new Array(byteChar.length);

              for (let i = 0; i < byteChar.length; i++){
                byteNum[i] = byteChar.charCodeAt(i);
              }
              const byteArr = new Uint8Array(byteNum);
              const blob = new Blob([byteArr], {type: 'img/png'});
              var imgBlobURL = URL.createObjectURL(blob);
              img.src = imgBlobURL;

              // upload
              const data = new FormData();
              data.append('authenticity_token', $('meta[name="csrf-token"]').attr('content'))
              data.append('file', blob, 'img.png');
              data.append('type', "composer");

              fetch(Discourse.getURL("/uploads.json"), {
                  method: 'POST',
                  body: data
              }).then(response => response.json()).then(upload=> {
                  const url = window.location.origin + upload.short_url.replace("upload://", Discourse.getURL('/uploads/short-url/'));
                  const newImgUrl = upload.short_url.substring(0,upload.short_url.length-4);
                  let str;
                  for(let i = 0; i < images.length; i++){
                    if(images[i] === img){                      
                      str = $editor.substring(result[i],result[i]+36);
                      console.log('str ',str)
                      break;
                    }
                  }
                  let newText;
                  Discourse.appEvents.trigger(
                      // "composer:insert-text",
                      // console.log(' url ', `\n![](${upload.short_url})\n`),
                      // ,
                      newText = $editor.replace(str,newImgUrl),
                      $editorVal.val(newText)
                    );
              });
        
                });  

                   //Makes sure markerjs toolbar is closed after preview topic is closed.
                   function checkOpen(){ 
                           if(!$(img).is(':visible')) {
                           try{
                               clearInterval(timer) 
                               mark.close();
                               }
                           catch(e)
                               {/*Do nothing*/}
                               }
                           } 
                   let timer = setInterval(checkOpen,3000);
                   
                   newObj = {
                               img,
                               previousState: mark.getState(),
                               mark
                           }
                   
                   //Hide composer scrolling temporarily
                   $(".d-editor-preview-wrapper ").css("overflow","hidden");
               
                   //Save state when toolbar clicked
                   $('.markerjs-toolbar').on("click", function(){
                       return saveState(newObj, img, mark)
                       })
                   //Save state when annotation changes
                   $('svg').on("click", function(){
                       return saveState(newObj, img, mark)
                       })
                       
                       return newObj
       }
</script> 
